# River Network Twin

## Постановка задачи

Проект представляет собой плагин для QGIS, предназначенный для создания цифрового двойника речной сети и комплексного анализа гидрологических систем. Плагин является частью проекта создания Цифрового двойника речной сети «СимПри», необходимого для разработки, реализации и мониторинга проектов восстановления полноводности рек для их судоходства, предотвращения наводнений, эрозионных процессов, заиливания русел рек, диффузного загрязнения речных потоков и гармонизации водно-климатического баланса урбанизированных территорий.

### Цель проекта

Создание ГИС-инструментов для построения границ естественной экосистемы, на которой она уже способна поддерживать необходимую полноводность и равномерность речного потока - **Экосистемного Каркаса (ЭК) речной сети**. Эти инструменты позволяют определить, какие функции естественной экосистемы водосбора рек необходимо восстановить на урбанизированных участках ЭК для достижения необходимой полноводности и равномерности водного потока, а также спланировать стратегию восстановления этих экосистемных функций.

### Основные задачи, решаемые плагином

#### 1. Зонирование территории водосбора реки

- **Выделение подземного русла реки и границ водоохранной зоны**: Определение подземного русла реки и построение водоохранных зон (100-150 м от края подземного русла) для предотвращения наводнений
- **Выделение коренных берегов**: Автоматическое определение коренных берегов по рельефу на основе анализа точек повышения высоты вдоль русла реки
- **Гидрологическое зонирование**: Выделение зон по крутизне склонов:
  - **Приводораздельная зона** (уклоны до 3°): зона питания подземных вод, борьба с ветровой эрозией, засухой, суховеями
  - **Присетьевая зона** (уклоны 3-9°): зона формирования поверхностного стока, плоскостная эрозия (смыв почвы)
  - **Гидрографическая зона** (уклоны более 9°): зона транзита поверхностного стока, линейная эрозия (овраги, балки)
- **Зонирование по протяженности реки**: Выделение истоковой (до 10 км), верхней (до 25 км), средней (25-50 км) и нижней (более 50 км) частей реки
- **Статистический анализ зон**: Подсчет общей площади, длины границ, средних уклонов по каждой зоне

#### 2. Анализ эрозионных процессов

- **Выделение зон, склонных к эрозии почв**: Расчет потерь почвы методом RUSLE (Revised Universal Soil Loss Equation) для определения зон высокого риска эрозии
- **Выделение зон выветривания осадков**: Анализ зон интенсивного выветривания на водоразделах на основе литологических и климатических факторов

#### 3. Построение речной сети и анализ стока

- **Построение речной сети**: Автоматическое извлечение и векторизация речной сети из DEM данных с возможностью кластеризации точек максимальной высоты
- **Анализ водосборных бассейнов**: Определение границ водосборных бассейнов и их характеристик
- **Анализ путей наименьшей стоимости**: Поиск оптимальных маршрутов стока воды с учетом топографии
- **Подземные водоразделы**: Моделирование подземных потоков и определение подземных водосборных бассейнов

#### 4. Проектирование защитных мероприятий

- **Расчет защитных лесополос**: Проектирование оптимального расположения защитных лесополос на основе анализа рельефа для борьбы с эрозией и задержания снега
- **Защитные зоны**: Определение защитных зон вокруг рек и водоразделов (поверхностные и подземные буферные зоны)

### Методологическая основа

Плагин реализует комплексный подход к анализу водосборных бассейнов, основанный на:

- **Гидрологическом зонировании**: Разделение территории на зоны по условиям формирования и перемещения стока (питание подземных вод, формирование поверхностного стока, истоки рек, транзит стока, разгрузка подземных вод)
- **Морфометрическом анализе**: Определение уклонов местности по формуле i = h/J, где h - высота сечений горизонталей, J - расстояние между горизонталями
- **Экосистемном подходе**: Определение дефицита лесистости для формирования оптимального уровня растительного каркаса экосистемы водосбора

Результаты зонирования используются для определения необходимой площади лесистости на всей территории водораздела для питания подземных вод и создания необходимой лесистости в водоохранных зонах речных долин.

## Описание функциональности

### 1. Построение речной сети

Модуль `river` обеспечивает:
- Загрузку DEM данных с OpenTopography API (SRTM GL1)
- Автоматическое извлечение речной сети из DEM
- Построение водосборных бассейнов
- Фильтрацию рек по порядку Стралера и длине
- Определение точек максимальной высоты для каждого сегмента реки
- Опциональную кластеризацию точек максимальной высоты для группировки истоков
- Интеграцию с данными OpenStreetMap для верификации водных объектов

**Параметры фильтрации рек:**
- Минимальный порядок Стралера: ≥ 2
- Минимальная длина: > 1000 м

**Параметры кластеризации:**
- Масштаб ресемплинга: 5
- Интервал изолиний: 20 м

### 2. Создание лесополос

Модуль `forest` позволяет:
- Интерактивный выбор области анализа путем указания точек на карте
- Автоматическое создание изолиний на основе DEM
- Генерацию лесополос вдоль изолиний с учетом параметров:
  - Высота (h): 15 м
  - Расстояние между полосами (j): 20 м
  - Угол наклона: 3°
- Визуализацию лесополос с цветовой дифференциацией

**Применение результатов зонирования:** Результаты зонирования территории водораздела используются для определения дефицита лесистости и формирования оптимального уровня растительного каркаса экосистемы. Лесомелиоративные насаждения проектируются в местах первичной концентрации поверхностного стока для формирования благоприятного водного режима малых рек и предотвращения эрозионных процессов. Необходимо обеспечить достаточную площадь лесистости для питания подземных вод на всей территории водораздела и создать необходимую лесистость в водоохранных зонах речных долин.

### 3. Анализ пути наименьшей стоимости

Модуль `least_cost_path` выполняет:
- Построение графа стоимости на основе DEM
- Расчет оптимальных путей между точками максимальной высоты
- Учет водных объектов как барьеров
- Определение границ водосборных бассейнов для каждого пути
- Визуализацию результатов в виде векторных слоев

### 4. Подземные водоразделы

Модуль `underground` обеспечивает:
- Построение растра стоимости подземного стока на основе:
  - Уклона поверхности
  - Глубины до уровня грунтовых вод
  - Проницаемости пород
  - Карстового индекса
- Расчет оптимальных путей подземного стока между источниками и выходами
- Построение полигонов подземных водосборных бассейнов
- Настраиваемые веса факторов стоимости

### 5. Защитные зоны и зонирование территории водосбора

Модуль `protection` создает:
- **Водоохранные зоны**: Буферные зоны вдоль русла реки от края подземного русла (100-150 м, настраивается оператором в зависимости от типа почвы)
- **Поверхностные защитные зоны**: Буферные зоны вокруг рек для защиты от поверхностного стока
- **Подземные защитные зоны**: Буферные зоны вокруг водоразделов для защиты подземных вод
- **Объединенные защитные зоны**: С классификацией типов (surface/subsurface)

**Параметры по умолчанию:**
- Поверхностный буфер: 200 м
- Подземный буфер: 500 м

**Методология зонирования по крутизне склонов:**

Плагин поддерживает выделение зон водосбора на основе анализа уклонов местности:

- **Приводораздельная зона** (уклоны до 3°):
  - Зона питания подземных вод
  - Процессы водной эрозии выражены слабо или отсутствуют
  - Мелиоративные мероприятия направлены на борьбу с ветровой эрозией, засухой, суховеями, задержание снега
  - Может потребоваться создание водозащитных лесополос на холмистых участках

- **Присетьевая зона** (уклоны 3-9°):
  - Зона формирования поверхностного стока
  - Характерна плоскостная эрозия (смыв почвы)
  - Мелиоративные мероприятия направлены на борьбу со смывом почвы

- **Гидрографическая зона** (уклоны более 9°):
  - Зона транзита поверхностного стока
  - Включает овраги и древнюю гидрографическую сеть
  - Характерна линейная эрозия
  - Используется под лугопастбища и лес

**Определение уклонов:** Уклоны определяются по формуле i = h/J, где h - высота сечений горизонталей (м), J - расстояние между горизонталями (м). Значение переводится из тысячных в градусы.

**Выделение коренных берегов:** Автоматическое определение коренных берегов реки на основе анализа точек повышения высоты вдоль русла по заданному порогу высоты.

### 6. Риск эрозии почв

Модуль `erosion` реализует:
- Расчет потерь почвы по методу RUSLE:
  - R - фактор осадков
  - K - фактор размываемости почв
  - LS - фактор длины и крутизны склона
  - C - фактор покрова
  - P - фактор защитных практик
- Создание растра потерь почвы (т/га/год)
- Генерацию маски зон высокого риска эрозии
- Полигонализацию зон риска

**Связь с зонированием:** Результаты анализа эрозии используются для определения зон, требующих особого внимания при планировании лесомелиоративных мероприятий. Наиболее эффективны лесомелиоративные насаждения в местах первичной концентрации поверхностного стока (водоразделах, приводораздельных и присетевых склонах, водоподводящих ложбинах, берегах овражно-балочной сети и у истоков рек).

### 7. Зоны выветривания

Модуль `weathering` выполняет:
- Расчет индекса выветривания на основе:
  - Уклона местности
  - Влажности/увлажнения
  - Литологического индекса
  - Температурной амплитуды
- Определение зон интенсивного выветривания по процентилю
- Пересечение с границами водоразделов для локализации зон

## Структура проекта

```
RiverNetwork/
└── river-network-twin-master/
    ├── __init__.py                 # Точка входа плагина
    ├── metadata.txt                # Метаданные плагина для QGIS
    └── src/
        ├── main.py                 # Главный класс плагина
        ├── common.py               # Общие утилиты (загрузка DEM, настройка CRS)
        ├── custom_path.py          # Инструмент построения пользовательских путей
        ├── forest.py               # Модуль создания лесополос
        ├── progress_manager.py     # Менеджер прогресса выполнения операций
        │
        ├── river/                  # Модуль построения речной сети
        │   ├── river.py            # Основная логика построения речной сети
        │   ├── point_selection_tool.py  # Инструмент выбора точек на карте
        │   └── layers/
        │       ├── basins.py              # Построение водосборных бассейнов
        │       ├── clustering.py          # Кластеризация точек
        │       ├── max_height_points.py   # Точки максимальной высоты
        │       ├── rivers_and_points.py   # Реки с высотными данными
        │       ├── rivers_by_object_filtered.py  # Фильтрация рек
        │       ├── rivers_merged.py       # Объединение рек
        │       ├── utils.py              # Утилиты для работы с OSM
        │       └── water_rasterized.py    # Растеризация водных объектов
        │
        ├── least_cost_path/        # Модуль анализа оптимальных путей
        │   ├── least_cost_path.py  # Основная логика расчета путей
        │   └── layers/
        │       ├── output_least_cost_path.py      # Выходные пути
        │       └── watershed_boundaries.py        # Границы водосборов
        │
        ├── underground/            # Модуль подземных водоразделов
        │   ├── runner.py           # Основная функция анализа
        │   ├── config.py           # Конфигурация входных данных
        │   ├── cost_builder.py     # Построение растра стоимости
        │   ├── datasource.py       # Загрузка векторных данных
        │   ├── network.py          # Построение сети путей
        │   └── polygonizer.py      # Полигонизация путей
        │
        ├── protection/             # Модуль защитных зон
        │   └── runner.py           # Расчет защитных зон
        │
        ├── erosion/                # Модуль эрозии почв
        │   ├── runner.py           # Основная функция анализа
        │   ├── config.py           # Конфигурация RUSLE
        │   └── analysis.py         # Расчет RUSLE и маски риска
        │
        ├── weathering/             # Модуль зон выветривания
        │   ├── runner.py           # Основная функция анализа
        │   ├── config.py           # Конфигурация входных данных
        │   └── analysis.py         # Расчет индекса выветривания
        │
        └── processing/             # Провайдер алгоритмов обработки
            ├── provider.py         # Регистрация алгоритмов
            └── algorithms/
                ├── build_underground_cost.py    # Алгоритм построения стоимости
                ├── protection_zone.py           # Алгоритм защитных зон
                ├── soil_erosion.py              # Алгоритм эрозии
                ├── underground_paths.py        # Алгоритм подземных путей
                └── weathering_zones.py         # Алгоритм зон выветривания
```

## Требования

### Системные требования

- **QGIS**: версия 3.16 или выше
- **Операционная система**: Windows, macOS, Linux
- **Python**: версия 3.x (встроенная в QGIS)

### Зависимости Python

Плагин использует следующие библиотеки (обычно входят в состав QGIS):

- `qgis` - Основной API QGIS
- `osgeo.gdal` - Работа с растровыми и векторными данными
- `networkit` - Построение графов и расчет путей
- `numpy` - Численные вычисления
- `pyproj` - Преобразование систем координат
- `requests` - HTTP-запросы для загрузки DEM данных
- `PyQt5` - GUI компоненты (входит в QGIS)

### Внешние сервисы

- **OpenTopography API**: для загрузки DEM данных (SRTM GL1)
  - Требуется API ключ (встроен в код)
- **OpenStreetMap** (через QuickOSM): для загрузки данных о водных объектах
- **OpenTopoMap**: для базовой подложки карты

## Установка

### Способ 1: Установка через менеджер плагинов QGIS

1. Откройте QGIS
2. Перейдите в меню `Плагины` → `Управление и установка плагинов`
3. Перейдите на вкладку `Установка из ZIP`
4. Выберите архив плагина или папку `river-network-twin-master`
5. Нажмите `Установить плагин`

### Способ 2: Ручная установка

1. Скопируйте папку `river-network-twin-master` в директорию плагинов QGIS:
   - **Windows**: `C:\Users\<username>\AppData\Roaming\QGIS\QGIS3\profiles\default\python\plugins\`
   - **macOS**: `~/Library/Application Support/QGIS/QGIS3/profiles/default/python/plugins/`
   - **Linux**: `~/.local/share/QGIS/QGIS3/profiles/default/python/plugins/`

2. Перезапустите QGIS

3. Включите плагин в меню `Плагины` → `Управление и установка плагинов` → `Установленные`

### Проверка установки

После установки плагин должен появиться:
- В меню QGIS: `Плагины` → `RiverNETWORK`
- На панели инструментов: иконка плагина

## Инструкции по запуску

### Базовый рабочий процесс

1. **Запуск плагина**:
   - Откройте QGIS
   - Нажмите на иконку плагина `RiverNETWORK` на панели инструментов
   - Или выберите `Плагины` → `RiverNETWORK` в меню

2. **Выбор рабочей папки**:
   - При первом запуске плагин попросит выбрать рабочую папку
   - В выбранной папке будет создана подпапка `work` для хранения промежуточных и выходных файлов
   - Все результаты будут сохраняться в этой папке

3. **Выбор функции анализа**:
   - После выбора папки откроется диалоговое окно с доступными функциями:
     - **Создать речную сеть** - базовое построение речной сети
     - **Создать речную сеть с кластеризацией** - построение с группировкой истоков
     - **Создать лесополосы** - проектирование защитных лесополос
     - **Вычислить путь наименьшей стоимости** - расчет оптимальных путей стока
     - **Вычислить путь наименьшей стоимости с кластеризацией** - расчет путей с кластеризацией
     - **Подземные водоразделы** - анализ подземных потоков
     - **Защитные зоны** - определение защитных зон
     - **Риск эрозии почв** - оценка эрозии по RUSLE
     - **Зоны выветривания** - анализ зон выветривания

4. **Выполнение анализа**:
   - Следуйте инструкциям в диалоговых окнах
   - Для некоторых функций потребуется указать область анализа или выбрать входные данные
   - Процесс выполнения отображается в окне прогресса

5. **Просмотр результатов**:
   - Все результаты автоматически добавляются в проект QGIS как векторные или растровые слои
   - Используйте диалог управления видимостью слоев для настройки отображения

### Детальные инструкции по функциям

#### Построение речной сети

1. Выберите функцию "Создать речную сеть" или "Создать речную сеть с кластеризацией"
2. Выберите метод определения области анализа:
   - **Радиус вокруг точки**: укажите центр и радиус в градусах
     - Можно ввести координаты вручную (EPSG:3857) или выбрать точку на карте
   - **Область по 4 точкам**: выберите 4 точки на карте, определяющие прямоугольную область
3. Дождитесь завершения анализа:
   - Загрузка DEM с OpenTopography
   - Построение водосборных бассейнов
   - Извлечение речной сети
   - Фильтрация и обработка рек
   - Определение точек максимальной высоты
   - (Опционально) Кластеризация точек

**Выходные слои:**
- `basins` - Водосборные бассейны
- `rivers_merged` - Объединенная речная сеть
- `rivers_by_object_filtered` - Отфильтрованная речная сеть
- `rivers_with_points` - Реки с высотными данными
- `MaxHeightPoints` - Точки максимальной высоты
- (Опционально) `Points_and_clusters` - Кластеризованные точки

#### Создание лесополос

1. Выберите функцию "Создать лесополосы"
2. Убедитесь, что в проекте есть DEM слой (плагин попытается найти его автоматически)
3. Выберите точки на карте, определяющие область анализа (минимум 3 точки)
4. Нажмите кнопку "Завершить сбор точек"
5. Дождитесь завершения обработки:
   - Создание полигона области
   - Обрезка DEM
   - Построение изолиний
   - Генерация лесополос

**Выходные слои:**
- `Selected Region` - Полигон выбранной области
- `Contours` - Изолинии рельефа
- `Filtered Contours` - Отфильтрованные изолинии
- `Forest Belts` - Защитные лесополосы

#### Анализ пути наименьшей стоимости

1. Сначала выполните построение речной сети (для получения точек максимальной высоты)
2. Выберите функцию "Вычислить путь наименьшей стоимости"
3. Дождитесь завершения расчета:
   - Построение графа стоимости
   - Расчет оптимальных путей между точками
   - Определение границ водосборных бассейнов

**Выходные слои:**
- `Least Cost Paths` - Оптимальные пути стока
- `Watershed Boundaries` - Границы водосборных бассейнов для каждого пути

#### Подземные водоразделы

1. Выберите функцию "Подземные водоразделы"
2. Укажите входные растры:
   - DEM (цифровая модель рельефа)
   - Поверхность грунтовых вод
   - Слой проницаемости
   - Слой карстового индекса
3. Укажите векторные слои:
   - Источники подземных вод (точечный слой)
   - Точки выхода подземной реки (точечный слой)
4. Настройте веса факторов стоимости (сумма должна быть ≤ 1.0):
   - Вес уклона (по умолчанию: 0.4)
   - Вес проницаемости (по умолчанию: 0.25)
   - Вес карстового индекса (по умолчанию: 0.2)
   - Вес глубины (рассчитывается автоматически)
5. Дождитесь завершения анализа

**Выходные слои:**
- `underground_cost.tif` - Растр стоимости подземного стока
- `underground_paths.gpkg` - Пути подземного стока
- `underground_basins.gpkg` - Полигоны подземных водосборных бассейнов

#### Защитные зоны

1. Убедитесь, что в проекте есть:
   - Слой водоразделов (полигональный)
   - Слой рек (линейный)
2. Выберите функцию "Защитные зоны"
3. Выберите слой водоразделов из списка
4. Выберите слой рек из списка
5. Укажите расстояния буферов:
   - Поверхностный буфер (по умолчанию: 200 м)
   - Подземный буфер (по умолчанию: 500 м)
6. Дождитесь завершения расчета

**Выходные слои:**
- `Protection zones` - Объединенные защитные зоны с атрибутом `zone` (surface/subsurface)

#### Риск эрозии почв

1. Подготовьте входные растры RUSLE:
   - R - фактор осадков (т/га/год)
   - K - фактор размываемости почв
   - LS - фактор длины и крутизны склона
   - C - фактор покрова (0-1)
   - P - фактор защитных практик (0-1)
2. Выберите функцию "Риск эрозии почв"
3. Выберите каждый из пяти растров через диалоговые окна
4. Укажите порог риска (минимальная потеря почвы для высокого риска, т/га/год, по умолчанию: 10.0)
5. Дождитесь завершения расчета

**Выходные слои:**
- `soil_loss.tif` - Растр потерь почвы (т/га/год)
- `soil_risk_mask.tif` - Маска зон высокого риска
- `Soil erosion zones` - Полигоны зон риска эрозии

#### Зоны выветривания

1. Подготовьте входные данные:
   - Слой водоразделов (полигональный)
   - Растр уклонов
   - Растр влажности/увлажнения
   - Растр литологии (индекс выветривания)
   - Растр температурной амплитуды
2. Выберите функцию "Зоны выветривания"
3. Выберите все входные слои через диалоговые окна
4. Укажите пороговый процентиль (по умолчанию: 85.0) - процент пикселей с наибольшим индексом выветривания
5. Дождитесь завершения анализа

**Выходные слои:**
- `weathering_index.tif` - Растр индекса выветривания
- `weathering_mask.tif` - Маска зон выветривания
- `Weathering zones` - Полигоны зон выветривания (пересечение с водоразделами)

### Инструмент построения пользовательских путей

После выполнения любого анализа речной сети или путей наименьшей стоимости становится доступным инструмент построения пользовательских путей:

1. На панели инструментов появится кнопка для построения пользовательских путей
2. Выберите начальную и конечную точки на карте
3. Плагин автоматически построит оптимальный путь между точками с учетом растра стоимости

## Документация по репозиторию

### Версионирование

Текущая версия плагина: **2.0**

Информация о версии хранится в файле `metadata.txt`:
- `name`: RiverNETWORK
- `version`: 2.0
- `qgisMinimumVersion`: 3.16
- `author`: spbu
- `category`: Прочее

### Формат данных

#### Входные данные

- **Растры**: GeoTIFF (.tif) в различных системах координат (автоматическое преобразование в EPSG:3857)
- **Векторные данные**: GeoPackage (.gpkg) или Shapefile (.shp)
- **DEM данные**: Автоматическая загрузка SRTM GL1 с разрешением 30 м

#### Выходные данные

Все результаты сохраняются в рабочей папке (`work`) в следующих форматах:
- **Векторные слои**: GeoPackage (.gpkg)
- **Растры**: GeoTIFF (.tif)
- **Временные файлы**: Shapefile (.shp, .shx, .dbf, .prj) - могут быть удалены после обработки

#### Системы координат

- **Рабочая система координат проекта**: EPSG:3857 (Web Mercator)
- **Входные координаты**: Поддерживаются любые системы координат (автоматическое преобразование)
- **Координаты для выбора области**: EPSG:4326 (WGS84) или EPSG:3857

### Структура выходных файлов

В рабочей папке создаются следующие файлы:

#### Для анализа речной сети:
- `srtm_output.tif` - Исходный DEM
- `srtm_output_3857.tif` - Перепроецированный DEM
- `river_dem_3857.tif` - DEM для анализа рек
- `basins.sdat` - Водосборные бассейны (SAGA format)
- `merge_result.gpkg` - Объединенная речная сеть
- `rivers.gpkg` - Реки из DEM
- `streams.gpkg` - Ручьи из DEM
- `water.gpkg` - Водные объекты из OSM
- `rivers_by_object_filtered.gpkg` - Отфильтрованная речная сеть
- `rivers_with_points.gpkg` - Реки с высотными данными
- `max_height_points.gpkg` - Точки максимальной высоты
- `Изолинии.gpkg` - Изолинии для кластеризации (если включена)
- `Points_and_clusters.gpkg` - Кластеризованные точки (если включена)

#### Для анализа путей наименьшей стоимости:
- `srtm_output_3857_pooled.tif` - Ресемплированный DEM
- `water_rasterized.tif` - Растеризованные водные объекты
- `least_cost_paths.gpkg` - Оптимальные пути
- `watershed_boundaries.gpkg` - Границы водосборов

#### Для подземных водоразделов:
- `underground_cost.tif` - Растр стоимости
- `underground_paths.gpkg` - Пути подземного стока
- `underground_basins.gpkg` - Полигоны подземных бассейнов

#### Для защитных зон:
- `protection_zones.gpkg` - Защитные зоны

#### Для эрозии почв:
- `soil_loss.tif` - Потери почвы
- `soil_risk_mask.tif` - Маска риска
- `soil_erosion_zones.gpkg` - Зоны риска эрозии

#### Для зон выветривания:
- `weathering_index.tif` - Индекс выветривания
- `weathering_mask.tif` - Маска зон
- `weathering_zones.gpkg` - Полигоны зон выветривания

#### Для лесополос:
- `masked_dem.tif` - Обрезанный DEM
- `reprojected_dem.tif` - Перепроецированный DEM
- `contours_output.shp` - Изолинии

### Алгоритмы обработки

Плагин регистрирует следующие алгоритмы в панели обработки QGIS:

1. **Build Underground Cost** - Построение растра стоимости для подземных потоков
2. **Underground Paths** - Расчет путей подземного стока
3. **Protection Zone** - Расчет защитных зон
4. **Soil Erosion** - Расчет эрозии почв по RUSLE
5. **Weathering Zones** - Определение зон выветривания

Алгоритмы доступны в панели обработки QGIS: `Обработка` → `Toolbox` → `River Network Twin`

### API и расширяемость

#### Основные классы

- `CustomDEMPlugin` - Главный класс плагина
- `RiverNetworkProvider` - Провайдер алгоритмов обработки
- `ProgressManager` - Управление прогрессом выполнения
- `CustomPathBuilder` - Построение пользовательских путей
- `PointSelectionTool` - Инструмент выбора точек на карте

#### Ключевые функции

- `river()` - Построение речной сети
- `forest()` - Создание лесополос
- `least_cost_path_analysis()` - Анализ оптимальных путей
- `underground_river_analysis()` - Анализ подземных водоразделов
- `protection_zone_analysis()` - Расчет защитных зон
- `soil_erosion_analysis()` - Оценка эрозии почв
- `weathering_zone_analysis()` - Анализ зон выветривания

### Обработка ошибок

Плагин включает обработку следующих ситуаций:
- Отмена пользователем операции (через диалог прогресса)
- Отсутствие необходимых входных данных
- Ошибки загрузки DEM с внешних сервисов
- Некорректные входные данные
- Проблемы с преобразованием координат

Все ошибки отображаются пользователю через диалоговые окна QMessageBox.

### Производительность

- **Загрузка DEM**: Зависит от размера области и скорости интернета (обычно 1-5 минут)
- **Построение речной сети**: Зависит от размера DEM (обычно 5-15 минут для области 0.5°×0.5°)
- **Кластеризация**: Дополнительно 2-5 минут
- **Анализ путей**: Зависит от количества точек (обычно 1-10 минут)
- **Подземные водоразделы**: Зависит от размера растра стоимости (обычно 5-20 минут)

Рекомендации:
- Используйте области анализа разумного размера (до 1°×1°)
- Для больших областей используйте ресемплинг DEM
- Кластеризация рекомендуется для областей с большим количеством истоков (>100)

### Ограничения

1. **Размер области анализа**: Рекомендуется не более 1°×1° для оптимальной производительности
2. **Качество DEM**: Зависит от качества данных SRTM (разрешение 30 м)
3. **Интернет-соединение**: Требуется для загрузки DEM и OSM данных
4. **Память**: Для больших областей может потребоваться значительный объем RAM (рекомендуется 8+ GB)

### Поддержка и разработка

- **Автор**: spbu (Санкт-Петербургский государственный университет)
- **Версия QGIS**: Минимум 3.16
- **Лицензия**: Не указана (уточните у автора)

### Известные проблемы

- При работе с очень большими областями возможны задержки в отображении слоев
- Некоторые операции могут занимать длительное время без возможности отмены на промежуточных этапах
- Загрузка DEM может завершиться ошибкой при проблемах с интернет-соединением

### Будущие улучшения

Возможные направления развития:
- Поддержка других источников DEM данных
- Оптимизация производительности для больших областей
- Расширенные возможности визуализации
- Экспорт результатов в различные форматы
- Интеграция с другими плагинами QGIS

---

## Заключение

Плагин River Network Twin предоставляет комплексный набор инструментов для анализа речных сетей и связанных гидрологических процессов. Он объединяет современные методы геопространственного анализа с удобным интерфейсом QGIS, делая сложные расчеты доступными для широкого круга пользователей.

Для получения дополнительной информации или сообщения об ошибках обратитесь к разработчикам проекта.
